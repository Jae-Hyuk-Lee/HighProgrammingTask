// 2023-2 고급프로그래밍 과제: 쭈꾸미 게임
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <time.h>
#include "jjuggumi.h"

#define	DATA_FILE	"jjuggumi.dat"

int jjuggumi_init(void);

// low 이상 high 이하 난수를 발생시키는 함수
int randint(int low, int high) {
	int rnum = rand() % (high - low + 1) + low;
	return rnum;
}

int jjuggumi_init(void) {
    srand((unsigned int)time(NULL));
    FILE* fp;
    fopen_s(&fp, "jjuggumi.dat", "r");
    if (fp == NULL) {
        return -1; // -1 리턴하면 메인함수에서 처리하고 종료
    }

    // 플레이어 데이터 load
    fscanf_s(fp, "%d", &n_player);
    printf("%d", n_player);
    for (int i = 0; i < n_player; i++) {
        // 아직 안 배운 문법(구조체 포인터, 간접참조연산자)
        PLAYER* p = &player[i];
        // 파일에서 각 스탯 최댓값 읽기
        fscanf_s(fp, "%s%d%d",
            p->name, (unsigned int)sizeof(p->name),
            &(p->intel), &(p->str));
        p->id = i;
        p->stamina = 100; // 100%
        // 현재 상태
        p->is_alive = true;
        p->hasitem = false;
        p->is_dead = true;
    }

    // 아이템 데이터 load
    fscanf_s(fp, "%d", &n_item);
    for (int i = 0; i < n_item; i++) {
        fscanf_s(fp, "%s%d%d%d",
            item[i].name, (unsigned int)sizeof(item[i].name),
            &(item[i].intel_buf),
            &(item[i].str_buf),
            &(item[i].stamina_buf));
    }
    fclose(fp);
    return 0;


}

void intro1() {
	system("cls");
	printf("===========================================================================\n");
	printf("=-------------------------------------------------------------------------=\n");
	printf("=---------------#-----##------------------------#-----##------------------=\n");
	printf("=-----##-----##-#-----##--#########--#########--#-----##-##------##-##----=\n");
	printf("=-----##-----##-#-----##-##---------##----------#-----##-###----###-##----=\n");
	printf("=-----##-----##-##----##-#------##--##-----##---##----##-####-##-##-##----=\n");
	printf("=-----##-----##--######---#########--#########---######--##-###--##-##----=\n");
	printf("=-#--##--#--##--------------------##---------##----------##---------------=\n");
	printf("=--###----###----------------------##---------##---------##---------------=\n");
	printf("=-------------------------------------------------------------------------=\n");
	printf("=---------------------------#########----##---###-----###-#########-------=\n");
	printf("=--------------------------##-----------####--####---####-##++++++--------=\n");
	printf("=--------------------------#---#####---##++##-#####-##-##-##++#########---=\n");
	printf("=---------------------------#########--#++++##-##-####-##-##++++++#-------=\n");
	printf("=-----------------------------------##--------###---------#########-------=\n");
	printf("=------------------------------------##--------##-------------------------=\n");
	printf("=-------------------------------------------------------------------------=\n");
	printf("===========================================================================\n");
	printf("\n");
	printf("===========================================================================\n\n");
	printf("                    쭈꾸미 게임에 오신 것을 환영합니다!\n\n");
	printf("===========================================================================\n");
	Sleep(1000);
}
void intro2() {
	system("cls");
	printf("===========================================================================\n");
	printf("=-------------------------------------------------------------------------=\n");
	printf("=---------------#-----##------------------------#-----##------------------=\n");
	printf("=-----##-----##-#-----##--#########--#########--#-----##-##------##-##----=\n");
	printf("=-----##-----##-#-----##-##---------##----------#-----##-###----###-##----=\n");
	printf("=-----##-----##-##----##-#------##--##-----##---##----##-####-##-##-##----=\n");
	printf("=-----##-----##--######---#########--#########---######--##-###--##-##----=\n");
	printf("=-#--##--#--##--------------------##---------##----------##---------------=\n");
	printf("=--###----###----------------------##---------##---------##---------------=\n");
	printf("=-------------------------------------------------------------------------=\n");
	printf("=---------------------------#########----##---###-----###-#########-------=\n");
	printf("=--------------------------##-----------####--####---####-##++++++--------=\n");
	printf("=--------------------------#---#####---##++##-#####-##-##-##++#########---=\n");
	printf("=---------------------------#########--#++++##-##-####-##-##++++++#-------=\n");
	printf("=-----------------------------------##--------###---------#########-------=\n");
	printf("=------------------------------------##--------##-------------------------=\n");
	printf("=-------------------------------------------------------------------------=\n");
	printf("===========================================================================\n");
	printf("\n");
	printf("===========================================================================\n\n");
	printf("                    쭈꾸미 게임에 오신 것을 환영합니다!\n");
	printf("                  총 %d명의 참가자로 쭈꾸미 게임을 시작합니다!\n\n", n_player);
	printf("===========================================================================\n");
	Sleep(2000);
}
void intro() {
	intro1();
	intro2();
}

void ending1() {
	system("cls");
	printf("=========================================================================\n\n");
	printf("                       쭈꾸미 게임의 우승자는 바로\n\n");
	printf("=========================================================================\n");
	Sleep(1000);

}
void ending2() {
	int winner = -1;

	for (int i = 0; i < n_player; i++)
		if (player[i].is_alive)
			winner = player[i].id;
	system("cls");

	printf("=========================================================================\n\n");
	printf("                       쭈꾸미 게임의 우승자는 바로\n");
	printf("                     %d번 플레이어입니다! 축하드립니다!\n\n", winner);
	printf("=========================================================================\n");
	Sleep(2000);

}

// 73
void ending3() {
	system("cls");
	printf("=========================================================================\n\n");
	printf("제한시간이 다 되었습니다.\n생존자는 ");
	for (int i = 0; i < n_player; i++) {
		if (player[i].is_alive) {
			printf("%d번 ", i);
			Sleep(1000);
		}
	}
	printf("입니다.\n\n");
	printf("=========================================================================\n");
	Sleep(3000);
}


void ending4() {
    system("cls");
    printf("=========================================================================\n\n");
    printf("게임이 끝났습니다.\n생존자는 ");
    for (int i = 0; i < n_player; i++) {
        if (player[i].is_dead) {
            player[i].is_alive = true;
            
            printf("%d번 ", i);
            Sleep(1000);
        }
    }
    printf("입니다.\n\n");
    printf("=========================================================================\n");
    Sleep(3000);
}

void ending() {
    int count = 0;
    
    for (int i = 0; i < n_player; i++)
    {
        if (player[i].is_alive == true)
        {
            count++;
        }
    }

	if (count == 1) {
		ending1();
		ending2();
	}
	else {
		ending3();
	}
}

int main(void) {
	jjuggumi_init();
	//sample();
	intro();
	//mugunghwa();
	//nightgame();
	juldarigi();
	//jebi();
	ending();
	return 0;
}
